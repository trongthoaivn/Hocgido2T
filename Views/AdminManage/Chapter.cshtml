
@{
    ViewBag.Title = "Chapter";
    Layout = "~/Views/Shared/_DashboardAdmin.cshtml";
}




<script src="~/Scripts/ckeditor/ckeditor.js"></script>
<script src="~/Scripts/crypto-js.min.js"></script>
<script src="~/Scripts/aes.min.js"></script>
<link href="~/Content/bootstrap-table.min.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap-table.min.js"></script>

<style>

    .item {
        margin-bottom: 20px;
    }
</style>




<div class="container">
    <h2 id="titleChaptermodal">Bài học : <input class="form-control" type="text" id="txt_tenbh" /></h2>
    <br />
    <div class=" row">
        <div class="col-md-12">
            <div id="LyThuyet">
                <h5><b>Lý thuyết</b></h5>
                <textarea name="editor"></textarea>
            </div>
        </div>

    </div>
    <br />
    <div class="row" style="margin-top:10px">
        <div class="col-md-6">
            <h5><b>Video</b></h5>
            <input class="form-control" type="text" id="txt_url" />
            <button type="button" style="margin-top:10px" class="btn btn-primary" onclick="check_video()"><i class="fas fa-search"></i></button>
            <button type="button" style="margin-top:10px" class="btn btn-primary" onclick="reset()"><i class="fas fa-sync"></i></button>
            <video id="my-video"
                   style="max-width: 100%; height: auto; width:auto"
                   @*autoplay*@
                   controls>
                <source src="" type="video/mp4" />
                <source src="" type="video/webm" />
            </video>
        </div>
        <div class="col-md-6">
            <h5><b>Câu hỏi</b></h5>

            <div class="cauhoi">
                <table class="table table-hover"
                       id="table_cauhoi"
                       data-toggle="table"
                       data-height="540"
                       data-search="true"
                       data-show-refresh="true"
                       data-detail-view="true"
                       data-buttons="custom_btn"
                       data-detail-formatter="dapan_view"
                       data-pagination="true"
                       data-page-list="[ 25, 50, 100, 200, All]">
                    <thead>
                        <tr>
                            <th data-field="CauHoi.NoiDungCauHoi">Câu hỏi</th>
                            <th data-field="CauHoi.MaCauHoi" data-formatter="btn_cauhoi" data-events="cauhoi_event">Tác vụ</th>
                        </tr>
                    </thead>

                </table>
            </div>
        </div>
    </div>
    <br />
    @*<div class="row">
        <button type="button" style="margin-top:10px" class="btn btn-danger" onclick="location.href ='/AdminManage/ManageCourse'">Hủy</button>
        <button type="button" style="margin-top:10px" class="btn btn-success" onclick="update_chapter()">Lưu</button>

    </div>*@

</div>


<div class="modal fade" id="modal-cauhoi" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="titlecoursemodal">Thông tin khóa học</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="wrap">
                    <label>Nội dung câu hỏi </label>
                    <textarea class="form-control" type="text" id="txt_cauhoi"></textarea>
                    <span class="focus-input"></span>
                </div>
                <div class="wrap">
                    <label>Thể loại </label>
                    <select class="custom-select" id="select_theloai">
                        <option value="TN" id="TN">Trắc nghiệm</option>
                        <option value="TL" id="TL">Tự luận</option>
                        <option value="KHAC" id="khac">Khác</option>
                    </select>
                    <span class="focus-input"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="add_kiemtra()">Lưu</button>
            </div>
        </div>
    </div>
</div>



<script>


    $(document).ready(function () {


        get_chapter()
        CKEDITOR.replace('editor', {
            width: "100%",
            height: "400px",
            uiColor: '#F5F5F5',
            allowedContent: true,
            extraPlugins: 'codesnippet',
            codeSnippet_languages: {}
        });
        get_cauhoi()
        $('#select_theloai').change(function () {
            cate = $(this).val()
            console.log(cate)
        })
    });

    var cate ="TN"

    function dapan_view(index, row) {
        var html = []
        $.each(row, function (key, value) {
            row.DapAns.forEach(e => {
                var cheked
                if (e.DapAnDung == true)
                    cheked = 'checked'
                else cheked = ''
                html.push(
                    '<div class="input-group mb-3">' +
                    '<div class="input-group-text">' +
                    '<input class="form-check-input mt-0" type="checkbox" ' + cheked + ' aria-label="Checkbox for following text input">' +
                    '</div>' +
                    '<input type="text" class="form-control" value="' + e.NoiDungDapAn + '" aria-label="Text input with checkbox">' +
                    '<button class="btn btn-danger delete"  href="javascript:void(0)" title="">' +
                    '<i class="fas fa-trash-alt"></i>' +
                    '</button>' +
                    '</div>')
            })
        })
        return html.join('')
    }

    function get_cauhoi() {
        
        $.get("../api/ds_cauhoi?mabh=" + get_id()).then(function (res) { 
            if (res.msg != null) {
                $("#table_cauhoi").bootstrapTable('removeAll')

                $("#table_cauhoi").bootstrapTable('append', res.msg)
            }
        })
    }

    function btn_cauhoi(value, row, index) {
        return [
            '<button class="btn btn-info detail"  href="javascript:void(0)" title="">',
            '<i class="fas fa-list-alt"></i>',
            '</button>  ',
            '<button class="btn btn-success add"  href="javascript:void(0)" title="">',
            '<i class="fas fa-plus-circle"></i>',
            '</button>  ',
            '<button class="btn btn-danger delete"  href="javascript:void(0)" title="">',
            '<i class="fas fa-trash-alt"></i>',
            '</button>  ',

        ].join('')
    }

    function custom_btn() {
        return {
            btn_themkh: {
                html: '<button type="button" name="btn_themkh" data-toggle="modal" data-target="#modal-cauhoi" class="btn btn-success"><i class="fa fas fa-plus"></i></button>',
                event: () => {
                }

            }
        }
    }

    function update_chapter() {
        var data = CryptoJS.AES.encrypt(CKEDITOR.instances.editor.getData(), get_id()).toString();
        $.post("../api/chinhsuabaihoc", {
            MaBaiHoc: get_id(),
            Video: $("#txt_url").val(),
            GioiThieu: $("#txt_tenbh").val(),
            LyThuyet: data
        }).done(function (data) {
            if (data.msg != "error")
                swal("Thông báo", "Lưu khóa học thành công", "success").then((value) => {
                    window.location = "/AdminManage/ManageCourse"
                });
            else swal("Lỗi ", "Đã có lỗi xảy ra !" + data.msg, "error");
        }).fail(function (data) {
            swal("Lỗi ", "Đã có lỗi xảy ra !" + data.error, "error");
        });
    }


    function get_id() {
        var url_string = window.location.href
        var url = new URL(url_string);
        var param = url.searchParams.get("ChapID");
        return param
    }

    function reset() {
        $.get("../api/chitietbaihoc?mabh=" + get_id()).then(function (res) {
            if (res.msg != "error") {
                $("#my-video source").attr("src", res.msg.Video)
                $("#txt_url").val(res.msg.Video)
            }
            $('#my-video')[0].load()
            $('#my-video')[0].play()
        })
    }

    function check_video() {
        $("#my-video source").attr("src", $("#txt_url").val())
        $('#my-video')[0].load()
        $('#my-video')[0].play()
    }

    function add_cauhoi(makt) {
        $.post("../api/themcauhoi", {
            NoiDungCauHoi: $("#txt_cauhoi").val(),
            TheLoai: cate,
            MaKT: makt
        }).done(function (res) {
            swal("Thông báo", "Lưu khóa học thành công", "success").then((value) => {
                $('#modal-cauhoi').modal('hide');
                $("#txt_cauhoi").val("")
                $("option").removeAttr("selected")
                $("tbody").remove()
                get_cauhoi()
               
                
            });
        }).fail(function (data) {
            swal("Lỗi ", "Đã có lỗi xảy ra !" + data.error, "error");
        });


        
    }
    function get_chapter() {

        $.get("../api/chitietbaihoc?mabh=" + get_id()).then(function (res) {
            if (res.msg != "error") {

                $("#my-video source").attr("src", res.msg.Video)
                $("#txt_url").val(res.msg.Video)
                $("#txt_tenbh").val(res.msg.GioiThieu)
                CKEDITOR.instances['editor'].setData(CryptoJS.AES.decrypt(res.msg.LyThuyet, get_id()).toString(CryptoJS.enc.Utf8))


                $("#chaptermodal").modal("hide")


            }
            $("#Chapterinfo").modal("show")


            $('#my-video')[0].load()

        })
    }

    function add_kiemtra() {
        $.get("../api/themkiemtra?mabh=" + get_id()).done(function (res) {
            if (res.msg != "error") {
               
                add_cauhoi(res.MaKT)
            }
            else
                wal("Lỗi ", "Đã có lỗi xảy ra !" + data.msg, "error");
        }).fail(function (data) {
            swal("Lỗi ", "Đã có lỗi xảy ra !" + data.error, "error");
        });
    }

    function del_cauhoi(mach) {
        $.get("../api/xoacauhoi?mach=" + mach).done(function (res) {
            if (res.msg != "error") {
                get_cauhoi()
            } else
                wal("Lỗi ", "Đã có lỗi xảy ra !" + data.msg, "error");
        }).fail(function (data) {
            swal("Lỗi ", "Đã có lỗi xảy ra !" + data.error, "error");
        });
    }

    window.cauhoi_event = {
        'click .detail': function (e, value, row, index) {
            console.log("chitite" + row.CauHoi.MaCauHoi)
        },
        'click .add': function (e, value, row, index) {
            console.log("add" + row.CauHoi.MaCauHoi)
        },
        'click .delete': function (e, value, row, index) {
            del_cauhoi(row.CauHoi.MaCauHoi)
        },
    }
</script>

